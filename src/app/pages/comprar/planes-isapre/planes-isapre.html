<div class="isapre-page">
  <header class="header-view">
    <div class="container-aligned">
      <h1>Planes Isapre</h1>
      <p>
        Compara planes con precios directos y
        <strong>sin costo adicional</strong>
      </p>
    </div>
  </header>

  <section class="search-bar">
    <div class="search-grid container-aligned">
      <div class="box-input">
        <label>Regi√≥n</label>
        <select [(ngModel)]="filtros.region">
          <option value="" disabled selected>Selecciona</option>
          <option value="RM">Metropolitana</option>
        </select>
      </div>

      <div class="box-input">
        <label class="label-info">
          Renta imponible bruta

          <span class="info-icon">
            i
            <span class="tooltip">
              ‚ùì ¬øQu√© significa ‚ÄúRenta imponible‚Äù y ‚ÄúRenta l√≠quida‚Äù?
             <p><strong>üîπ Renta imponible</strong></p>
              <p>
                Es el sueldo bruto sobre el cual se calculan tus cotizaciones obligatorias,
                incluyendo el <strong>7% de salud</strong>.
              </p>

              <p class="highlight">
                üëâ Las Isapres calculan el valor del plan siempre sobre este monto,
                no sobre el sueldo l√≠quido.
              </p>

              <p class="example">
    <strong>Ejemplo:</strong><br>
    Si tu renta imponible es $1.000.000, tu 7% de salud corresponde a $70.000.
  </p>

  <hr>

  <p><strong>üîπ Renta l√≠quida</strong></p>
  <p>
    Es el dinero que recibes finalmente en tu cuenta,
    despu√©s de descontar salud, AFP e impuestos.
  </p>

  <p class="highlight">
    üëâ No se utiliza para calcular planes de Isapre,
    solo refleja tu ingreso final.
  </p>

  <hr>

  <p><strong>‚úÖ ¬øPor qu√© te pedimos la renta imponible?</strong></p>
  <p>
    Porque la ley exige que el 7% de salud se calcule sobre la renta imponible.
    As√≠ podemos mostrarte planes reales, precios correctos y opciones
    que efectivamente puedes contratar.
  </p>

              <p></p>

            </span>
          </span>
        </label>

        <input type="number" [(ngModel)]="filtros.ingreso" placeholder="$ 0" />
      </div>

      <div class="box-input">
        <label>Edad</label>
        <input type="number" [(ngModel)]="filtros.edad" />
      </div>

      <div class="box-input">
        <label class="label-info">
          <span class="label-text">Sistema de salud actual</span>
          <span class="info-icon">i</span>
        </label>

        <div class="health-select" (clickOutside)="healthOpen = false">
          <div class="health-selected" (click)="healthOpen = !healthOpen">
            {{ healthSelected || 'Selecciona' }}
            <span class="arrow" [class.open]="healthOpen">‚åÑ</span>
          </div>

          <div class="health-dropdown" *ngIf="healthOpen">
            <div class="health-option" (click)="selectHealth('Fonasa')">
              Fonasa
            </div>
            <div class="health-option" (click)="selectHealth('Banm√©dica')">
              Banm√©dica
            </div>
            <div class="health-option" (click)="selectHealth('Colmena')">
              Colmena
            </div>
            <div class="health-option" (click)="selectHealth('Consalud')">
              Consalud
            </div>
            <div class="health-option" (click)="selectHealth('Cruz Blanca')">
              Cruz Blanca
            </div>
            <div class="health-option" (click)="selectHealth('Nueva Masvida')">
              Nueva Masvida
            </div>
            <div class="health-option" (click)="selectHealth('Vida Tres')">
              Vida Tres
            </div>
            <div class="health-option" (click)="selectHealth('Esencial')">
              Esencial
            </div>
            <div class="health-option" (click)="selectHealth('No tiene')">
              No tiene
            </div>
          </div>
        </div>
      </div>

      <!-- BOT√ìN + POPOVER ASEGURADOS -->
      <div class="box-input group-modal">
        <label>Asegurados</label>

        <button class="trigger" (click)="toggleModal()">
          {{ (cargas.length > 0 || tieneConyuge) ? 'Modificar asegurados' : 'Agregar asegurados' }}
        </button>

        <!-- POPOVER (mini modal debajo del bot√≥n) -->
        <div class="popover-modal" *ngIf="mostrarModal">

          <!-- HEADER -->
          <div class="popover-head">
            <span>Agregar asegurados</span>
            <button (click)="mostrarModal = false">√ó</button>
          </div>

          <!-- CONTENIDO -->
          <div class="popover-content">

            <!-- CONYUGE TOGGLE -->
      

            <!-- CONYUGE DETAILS -->
            <div class="conyuge-details" *ngIf="tieneConyuge">

              <div class="conyuge-row-inline">

                <!-- SISTEMA DE SALUD -->
                <div class="sex-pick-full">
                  <label>Sistema de salud actual</label>

                  <div
                    class="health-select"
                    (clickOutside)="conyugeHealthOpen = false"
                  >
                    <div
                      class="health-selected"
                      (click)="conyugeHealthOpen = !conyugeHealthOpen"
                    >
                      {{ conyuge.sistemaSalud || 'Selecciona' }}
                      <span
                        class="arrow"
                        [class.open]="conyugeHealthOpen"
                      >‚åÑ</span>
                    </div>

                    <div
                      class="health-dropdown"
                      *ngIf="conyugeHealthOpen"
                    >
                      <div class="health-option" (click)="selectConyugeHealth('Fonasa')">Fonasa</div>
                      <div class="health-option" (click)="selectConyugeHealth('Banm√©dica')">Banm√©dica</div>
                      <div class="health-option" (click)="selectConyugeHealth('Colmena')">Colmena</div>
                      <div class="health-option" (click)="selectConyugeHealth('Consalud')">Consalud</div>
                      <div class="health-option" (click)="selectConyugeHealth('Cruz Blanca')">Cruz Blanca</div>
                      <div class="health-option" (click)="selectConyugeHealth('Nueva Masvida')">Nueva Masvida</div>
                      <div class="health-option" (click)="selectConyugeHealth('Vida Tres')">Vida Tres</div>
                      <div class="health-option" (click)="selectConyugeHealth('Esencial')">Esencial</div>
                      <div class="health-option" (click)="selectConyugeHealth('No tiene')">No tiene</div>
                    </div>
                  </div>
                </div>

                <!-- EDAD -->
                <div class="age-pick-full">
                  <label>Edad*</label>
                  <input
                    type="number"
                    [(ngModel)]="conyuge.edad"
                    placeholder="27"
                  />
                </div>
              </div>

              <!-- INGRESO -->
              <div class="input-full-width">
                <label>Ingreso Mensual L√≠quido*</label>
                <input
                  type="text"
                  [(ngModel)]="conyuge.ingreso"
                  placeholder="$ 0"
                />
              </div>
            </div>

            <!-- CARGAS -->
            <div class="popover-row">
              <label>Cargas</label>
              <div class="stepper">
                <button (click)="decrementarCargas()">‚àí</button>
                <span>{{ cargas.length }}</span>
                <button (click)="incrementarCargas()">+</button>
              </div>
            </div>

            <!-- LISTA DE CARGAS -->
            <div class="cargas-dynamic-list" *ngIf="cargas.length > 0">
              <div
                class="carga-card-item"
                *ngFor="let c of cargas; let i = index"
              >
                <p>Carga {{ i + 1 }}</p>

                <div class="carga-row-inline">
                  <div class="age-pick-full">
                    <label>Edad</label>
                    <input
                      type="number"
                      [(ngModel)]="c.edad"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- CTA -->
          <button class="btn-main-action" (click)="buscarPlanes()">
            Agregar y calcular precios
          </button>

        </div>
      </div>

      <button class="btn-search" (click)="buscarPlanes()">
        Calcular precios
      </button>
    </div>
  </section>

  <section class="results-bar">
    <div class="container-aligned results-grid">
      <div class="results-count">
        <h2>{{ resultados.length }} Resultados</h2>
      </div>

      <div class="rating-toggle">
        <label>
          <span class="info-link" (click)="mostrarInfo7Porciento()"> Reajustados a tu 7 %</span>
        </label>
      </div>

      <div class="sort-select">
        <label>Ordenar por:</label>
        <select [(ngModel)]="ordenarPor">
          <option value="price">Mayor Puntaje</option>
          <option value="rating">Precio Menor a Mayor</option>
          <option value="coverage">Precio Mayor a Menor</option>
        </select>
      </div>

      <div class="currency-select">
        <label>Moneda:</label>
        <select>
          <option value="clp">Pesos</option>
          <option value="uf">UF</option>
        </select>
      </div>

      <div class="view-mode-toggle">
        <button
          [class.active]="vista === 'list'"
          (click)="cambiarVista('list')"
        >
          <span>&#9776;</span>
        </button>
        <button
          [class.active]="vista === 'grid'"
          (click)="cambiarVista('grid')"
        >
          <span>&#9638;</span>
        </button>
      </div>
    </div>
  </section>
</div>

<div class="container results-layout">
  <!-- SIDEBAR -->
  <div class="sidebar-wrapper">
    <aside class="sidebar">
      <h4>Precio</h4>
      <div class="price-box">
        <span>$137.157 - $151.594</span>
        <span class="max-price">$380.000</span>
        <input type="range" />
      </div>
    </aside>

    <aside class="sidebar">
      <!-- ===============================
       AUTOCOMPLETE CL√çNICAS
  ================================ -->
      <h4 class="title-inline">
        Cl√≠nicas y Hospitales
        <span class="info">i</span>
      </h4>

      <div class="autocomplete">
        <input
          type="text"
          class="input"
          placeholder="Cl√≠nica..."
          [(ngModel)]="clinicaSearch"
          (input)="filtrarClinicas()"
          (focus)="mostrarLista = true"
        />

        <ul
          class="autocomplete-list"
          *ngIf="mostrarLista && clinicasFiltradas.length"
        >
          <li
            *ngFor="let clinica of clinicasFiltradas"
            (click)="seleccionarClinica(clinica)"
          >
            {{ clinica }}
          </li>
        </ul>
      </div>

      <label class="checkbox">
        <input type="checkbox" checked />
        Libre elecci√≥n <span class="count">51</span>
      </label>

      <label class="checkbox">
        <input type="checkbox" checked />
        Preferentes <span class="count">25</span>
      </label>
    </aside>
  </div>
  <main class="results" id="cards-start">
    <!-- CARDS -->
    <div class="card" *ngFor="let plan of resultadosPaginados">
      <div class="card-left">
        <span class="tag">Preferente</span>

        <div class="company">
          <img src="https://via.placeholder.com/40" />
          <strong>{{ plan.isapre }}</strong>
        </div>

        <h5>{{ plan.nombrePlan }}</h5>

        <div class="features">
          <span>üè• Hospitalaria 90%</span>
          <span>üöë Urgencia 70%</span>
          <span>ü©∫ Ambulatoria 70%</span>
          <span>üìÑ Tope anual 7.000 UF</span>
        </div>
      </div>

      <div class="card-center">
        <label> <input type="checkbox" /> Comparar </label>

        <div class="score" *ngIf="mostrarPuntaje">
          Puntaje
          <span class="score-value">7.8</span>
          <small>de 7.8</small>
        </div>
      </div>

      <div class="card-right">
        <span class="price-label">Desde</span>
        <span class="price">${{ plan.valor | number:'1.0-0' }}</span>
        <small>/mes</small>

        <button class="btn-solicitar" (click)="abrirSolicitud(plan)">
          Solicitar
        </button>

        <button class="btn-secondary" (click)="abrirDetalle(plan)">
          Ver detalle
        </button>
      </div>
    </div>

    <!-- PAGINACI√ìN -->
    <div class="pagination" *ngIf="totalPaginas > 1">
      <button (click)="paginaAnterior()" [disabled]="paginaActual === 1">
        ‚Äπ Anterior
      </button>

      <!-- P√°gina 1 -->
      <button
        *ngIf="mostrarPrimeraPagina"
        (click)="irAPagina(1)"
        [class.active]="paginaActual === 1"
      >
        1
      </button>

      <!-- Dots inicial -->
      <span class="dots" *ngIf="mostrarDotsInicio">‚Ä¶</span>

      <!-- P√°ginas centrales -->
      <button
        *ngFor="let page of paginasVisibles"
        (click)="irAPagina(page)"
        [class.active]="paginaActual === page"
      >
        {{ page }}
      </button>

      <!-- Dots final -->
      <span class="dots" *ngIf="mostrarDotsFinal">‚Ä¶</span>

      <!-- √öltima p√°gina -->
      <button
        *ngIf="mostrarUltimaPagina"
        (click)="irAPagina(totalPaginas)"
        [class.active]="paginaActual === totalPaginas"
      >
        {{ totalPaginas }}
      </button>

      <button
        (click)="paginaSiguiente()"
        [disabled]="paginaActual === totalPaginas"
      >
        Siguiente ‚Ä∫
      </button>
    </div>
  </main>
</div>

<app-modal-detalle
  [plan]="planSeleccionado"
  [isVisible]="mostrarDetalleModal"
  (close)="cerrarDetalle()"
  (solicitar)="desdeDetalleASolicitar()"
>
</app-modal-detalle>

<app-modal-solicitar
  [plan]="planSeleccionado"
  [isVisible]="mostrarSolicitarModal"
  (close)="cerrarSolicitar()"
  (submitForm)="procesarSolicitud($event)"
  (verDetallePlan)="abrirDetalleDesdeSolicitar()"
>
</app-modal-solicitar>
