<div class="modal-overlay" *ngIf="isVisible" (click)="close.emit()">
  <div class="modal-container" (click)="$event.stopPropagation()">

    <!-- HEADER -->
    <div class="modal-header-wrapper">
      <div class="modal-header">

        <!-- INFO PLAN -->
        <div class="plan-info-header">
          <img
            [src]="'assets/logos/vidatres.png' + (plan.nombrePlan || '').toLowerCase().replace(' ', '') + '.png'"
            class="isapre-logo-modal"
          />

          <div class="text-info">
            <span class="rating">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>
            <span class="plan-recommendation">Plan recomendado</span>
            <h2 class="plan-title">{{ plan.nombrePlan }}</h2>

            <p *ngIf="plan?.puntaje">
              Puntuaci√≥n:
              <span class="score-badge">{{ plan.puntaje | number:'1.1-1' }}</span>
            </p>
          </div>
        </div>

        <!-- PRECIO + SOLICITAR -->
        <div class="plan-price-action">
          <span class="price-amount">
            ${{ plan.precioFinal | number:'1.0-0' }} <span>/mes</span>
          </span>

          <button class="btn-solicitar-modal" (click)="solicitar.emit()">
            SOLICITAR PLAN
          </button>
        </div>

        <button class="btn-close" (click)="close.emit()">√ó</button>
      </div>

      <!-- TABS -->
      <div class="modal-tabs">
        <button (click)="tabActiva='vistaGeneral'" [class.active]="tabActiva==='vistaGeneral'">Vista General</button>
        <button (click)="tabActiva='contrato'" [class.active]="tabActiva==='contrato'">Contrato</button>
        <button (click)="tabActiva='puntaje'" [class.active]="tabActiva==='puntaje'">Puntaje</button>
        <button (click)="tabActiva='precio'" [class.active]="tabActiva==='precio'">Precio</button>
      </div>
    </div>

    <!-- CONTENIDO -->
    <div class="modal-content-body">

      <!-- üîπ VISTA GENERAL -->
      <div *ngIf="tabActiva==='vistaGeneral'" class="vista-general-tab-container">
        <h3 class="tab-section-title">Caracter√≠sticas de este plan</h3>

        <p class="plan-subtitle">
          Este plan es <b>{{plan.preferente}}</b> y est√° pensado para quienes idealmente
          se atienden en los siguientes lugares de preferencia:
        </p>

        <div class="vista-grid">
          <!-- ====================== -->
          <!-- COLUMNA IZQUIERDA     -->
          <!-- ====================== -->
          <div class="columna-izq">
            <!-- COBERTURA PREFERENTE -->
            <h4 class="section-title">Cobertura Preferente</h4>

            <div class="tabla-preferente">
              <table>
                <thead>
                  <tr>
                    <th>Prestador</th>
                    <th>Hospitalaria</th>
                    <th>Ambulatoria</th>
                    <th>Urgencia</th>
                  </tr>
                </thead>

                <tbody>
                  <tr *ngFor="let item of prestadoresPreferentes">
                    <td>
                      <i class="fas fa-check-circle check"></i> {{
                      item.prestador }}
                    </td>
                    <td>{{ item.hospitalario }}</td>
                    <td>{{ item.ambulatorio }}</td>
                    <td>{{ item.urgencia }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- COBERTURA LIBRE ELECCI√ìN -->
            <h4 class="section-title">Cobertura Libre Elecci√≥n</h4>
            <p class="le-subtitle">
              Para el resto de los prestadores la cobertura es:
            </p>

            <div class="libre-eleccion-box">
              <div class="le-row">
                <div class="le-left">
                  <p class="le-title">Cobertura Hospitalaria</p>
                  <small>(Operaciones, enfermedades, etc.)</small>
                </div>
                <div class="le-right">
                  <span class="le-porcentaje">{{plan.hospitalaria}}%</span>
                </div>
              </div>

              <div class="le-divider"></div>

              <div class="le-row">
                <div class="le-left">
                  <p class="le-title">Cobertura Ambulatoria</p>
                  <small>(Consultas m√©dicas, ex√°menes, etc.)</small>
                </div>
                <div class="le-right">
                  <span class="le-porcentaje">{{plan.ambulatoria}}%</span>
                </div>
              </div>
            </div>

            <!-- RESTRICCIONES + TOPES -->
            <div class="restricciones-topes">
              <div class="restricciones-col">
                <p class="restricciones-title">Tendr√°s menos cobertura en:</p>
                <ul>
                  <li>Cirug√≠a bari√°trica</li>
                  <li>Cirug√≠a refractiva</li>
                  <li>Otras prestaciones restringidas</li>
                </ul>
              </div>

              <div class="topes-col">
                <div class="tope-card">
                  <i class="fas fa-home icon"></i>
                  <div>
                    <p>
                      Este plan cubre hasta <b>{{plan.topeAnualUf}} UF</b> ($277.531.940 al a√±o
                      por persona).
                    </p>
                    <small
                      >Excedido este monto se bonifica el
                      <b>m√≠nimo legal</b></small
                    >
                  </div>
                </div>

                <div class="tope-card">
                  <i class="fas fa-baby icon"></i>
                  <p>Este plan es <b>con cobertura de parto</b></p>
                </div>
              </div>
            </div>
          </div>

          <!-- ====================== -->
          <!-- COLUMNA DERECHA       -->
          <!-- ====================== -->
          <div class="columna-der">
            <h4 class="section-title">Beneficios de {{ plan.nombrePlan }}</h4>

            <div class="beneficios-grid">
              <div class="benef-card">
                <i class="fas fa-virus"></i> Beneficios COVID-19
              </div>
              <div class="benef-card">
                <i class="fas fa-tooth"></i> Dental y √ìptica
              </div>
              <div class="benef-card">
                <i class="fas fa-syringe"></i> Medicina Preventiva
              </div>
              <div class="benef-card">
                <i class="fas fa-map-marker-alt"></i> Red M√©dica Prioritaria
              </div>
              <div class="benef-card">
                <i class="fas fa-child"></i> Control Ni√±o Sano
              </div>
              <div class="benef-card">
                <i class="fas fa-headset"></i> Asesor√≠a Legal
              </div>
              <div class="benef-card">
                <i class="fas fa-briefcase-medical"></i> Salud Ocupacional
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- üîπ CONTRATO (SIN FORMULARIO) -->
      <div *ngIf="tabActiva==='contrato'" class="contrato-tab-container">
        <div class="contrato-grid">
          <!-- ========================= -->
          <!--   IZQUIERDA: CONTRATO    -->
          <!-- ========================= -->
          <div class="contrato-left">
            <h3 class="tab-section-title">T√©rminos y Condiciones del Plan</h3>

            <div class="contrato-box">
              <img
                *ngIf="plan.imagenContrato"
                [src]="plan.imagenContrato"
                alt="Contrato del plan"
                class="contrato-img"
              />

              <p *ngIf="!plan.imagenContrato" class="contrato-placeholder">
                Aqu√≠ se mostrar√° el documento de contrato cuando est√©
                disponible.
              </p>
            </div>

            <blockquote class="nota-legal">
              "El presente Plan de Salud se rige por la Ley N¬∞18.933 y sus
              reglamentos. Se recomienda leer detenidamente las cl√°usulas de
              exclusi√≥n y periodos de carencia."
            </blockquote>
          </div>

          <!-- ========================= -->
          <!--   DERECHA: FORMULARIO     -->
          <!-- ========================= -->
          <div class="contrato-right">
            <h3 class="tab-section-title">Solicitar</h3>
            <p class="solicitar-subtitle">
              Contrata y/o recibe asesor√≠a mediante un ejecutivo especializado
            </p>

            <form class="form-solicitud-grid">
              <div class="form-group">
                <label>Nombre*</label>
                <input type="text" placeholder="Ingresa tu nombre" required />
              </div>

              <div class="form-group">
                <label>Rut*</label>
                <input type="text" placeholder="Rut" required />
              </div>

              <div class="form-group">
                <label>Correo Electr√≥nico*</label>
                <input type="email" placeholder="Correo Electr√≥nico" required />
              </div>

              <div class="form-group">
                <label>Tel√©fono*</label>
                <input type="tel" placeholder="Tel√©fono" required />
              </div>

              <div class="form-group-full">
                <span class="radio-group-label"
                  >¬øEs {{ plan.nombrePlan }} tu Isapre Actual?</span
                >

                <div class="radio-options-inline">
                  <div class="radio-option">
                    <input type="radio" name="isapre" value="si" />
                    <label>S√≠</label>
                  </div>

                  <div class="radio-option">
                    <input type="radio" name="isapre" value="no" />
                    <label>No</label>
                  </div>
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn-solicitar-ejecutivo">
                  <i class="fas fa-user-tie"></i> Solicitar con ejecutivo
                </button>
                <small class="sitio-seguro">
                <i class="fas fa-lock"></i> Sitio seguro
                </small>
              </div>

            </form>
          </div>
        </div>
      </div>

      <!-- üîπ PUNTAJE -->
      <div *ngIf="tabActiva === 'puntaje'" class="puntaje-tab-container">
        <h3 class="tab-section-title">Puntaje de este Plan</h3>
        <p class="description">Desglose del puntaje del plan.</p>
      </div>

      <!-- üîπ Precio -->
      <div *ngIf="tabActiva === 'precio' && plan" class="precio-tab-container">

        <h3 class="tab-section-title">
          ¬øC√≥mo se calcula el precio de tu plan?
        </h3>

        <div class="price-card">

          <!-- üí∞ Precio base -->
          <div class="price-step">
            <div class="step-left">
              <span class="icon">üí∞</span>
              <span class="step-label">Precio base del plan</span>
            </div>
            <span class="step-value">
              {{ plan.precioBase | number:'1.2-2' }} UF
            </span>
          </div>

          <!-- üë§ Edad -->
          <div class="price-step" *ngIf="plan.detallePrecio">
            <div class="step-left">
              <span class="icon">üë§</span>
              <span class="step-label">
                Factor por edad ({{ plan.detallePrecio.edadTitular }} a√±os)
              </span>
            </div>
            <span class="step-value positive">
              √ó {{ plan.detallePrecio.factorEdad | number:'1.2-2' }} UF
            </span>
          </div>

          <!-- üë®‚Äçüë©‚Äçüëß Cargas -->
          <div class="price-step" *ngIf="plan.detallePrecio">
            <div class="step-left">
              <span class="icon">üë®‚Äçüë©‚Äçüëß</span>
              <span class="step-label">
                {{ plan.detallePrecio.factorCargas > 0 ? 'Factor por cargas familiares' : 'Sin cargas familiares' }}
              </span>
            </div>
            <span class="step-value">
              + {{ plan.detallePrecio.factorCargas | number:'1.2-2' }} UF
            </span>
          </div>

          <!-- üè• Isapre -->
          <div class="price-step" *ngIf="plan.detallePrecio">
            <div class="step-left">
              <span class="icon">üè•</span>
              <span class="step-label">
                GES
                <small class="hint">
                  (0.731 UF √ó {{ plan.detallePrecio.beneficiarios }} beneficiarios)
                </small>
              </span>
            </div>
            <span class="step-value">
              + {{ plan.detallePrecio.factorIsapreUF | number:'1.3-3' }} UF
            </span>
          </div>

          <!-- üîª Descuento -->
          <div
            class="price-step discount"
            *ngIf="plan.detallePrecio.descuento > 0"
          >
            <div class="step-left">
              <span class="icon">üîª</span>
              <span class="step-label">Descuento por renta</span>
            </div>
            <span class="step-value negative">
              - {{ plan.detallePrecio.descuento * 100 | number:'1.0-0' }}%
            </span>
          </div>

        </div>

        <!-- üßÆ Resultado final -->
        <div class="price-total-card">
          <span class="total-label">Precio final mensual</span>
          <span class="total-value">
            ${{ plan.precioFinal | number:'1.0-0' }}
            <small>/mes</small>
          </span>
        </div>

      </div>








      <!-- FOOTER -->
      <div class="modal-footer-fijo">
        <div class="footer-left">
          <span class="footer-plan-nombre">{{ plan.nombrePlan }}</span>
          <span class="footer-plan-precio">
            ${{ plan.precioFinal | number:'1.0-0' }}<small>/mes</small>
          </span>
        </div>

        <div class="footer-center">
          <button class="btn-solicitar-footer" (click)="irASolicitar()">
            SOLICITAR PLAN
          </button>
        </div>

        <div class="footer-right">
          <button class="btn-cerrar-footer" (click)="close.emit()">
            Cerrar
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

